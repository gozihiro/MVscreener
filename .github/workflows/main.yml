name: Stock Screener Full Auto

on:
  workflow_dispatch: # スマホやブラウザから手動で実行するためのボタン

jobs:
  run-screener:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install yfinance pandas numpy requests google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Run Screener
        run: python screener.py

      - name: Upload to Google Drive
        env:
          GDRIVE_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          python - <<EOF
          import os, json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          # 秘密情報の読み込み（改行が含まれていてもjson.loadsが適切に処理します）
          info = json.loads(os.environ['GDRIVE_JSON'])
          creds = service_account.Credentials.from_service_account_info(info, scopes=['https://www.googleapis.com/auth/drive'])
          service = build('drive', 'v3', credentials=creds)

          # 指定されたフォルダID（1n8b35TYpli2L1ZzXV9_HAe0pQPqHZidJ）を直接使用
          folder_id = os.environ['GDRIVE_FOLDER_ID']
          file_name = 'minervini_final_results.csv'

          # アップロード設定
          file_metadata = {'name': file_name, 'parents': [folder_id]}
          media = MediaFileUpload(file_name, mimetype='text/csv')
          
          # 実行
          try:
              file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
              print(f"転送成功！ Google Drive上のFile ID: {file.get('id')}")
          except Exception as e:
              print(f"アップロード中にエラーが発生しました: {e}")
              raise e
          EOF
